<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Control - Cocina</title>
    <meta name="theme-color" content="#f0f2f5" />
    <meta name="description" content="Control - Cocina" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- https://github.com/jackestar/ESP01S-Kitchen/ -->
    <link
      rel="shortcut icon"
      href="https://raw.githubusercontent.com/jackestar/ESP01S-Kitchen/master/icon.png"
      type="image/png"
    />
    <style>
      body {
        margin: 0;
        padding: 2em;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #f0f2f5;
        color: #333;
        box-sizing: border-box;
      }

      h2,
      h3 {
        color: #1c1c1e;
      }

      .status {
        display: flex;
        justify-content: space-around;
        width: 100%;
        max-width: 400px;
        background-color: #fff;
        padding: 0.5em 1em;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 1em;
      }

      .status p {
        padding: 0.5em;
      }

      .time {
        display: flex;
        justify-content: center;
        font-size: 2em;
        font-family: monospace;
        margin: 0.5em 0;
      }

      .control-container {
        position: relative;
        width: 200px;
        height: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 1em 0;
      }

      .control-container > svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: rotate(-90deg); /* Start from the top */
      }

      .slider-track,
      .slider-progress {
        fill: none;
        stroke-width: 20;
      }

      .slider-track {
        stroke: #e6e6e6;
      }

      .slider-progress {
        stroke: #007aff;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.1s linear;
      }

      #pwm-value {
        position: absolute;
        bottom: -35px;
        font-size: 1.5em;
        font-family: monospace;
        color: #555;
      }

      button[name="toggle"] {
        width: 120px;
        height: 120px;
        border: none;
        border-radius: 50%;
        background-color: #fff;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: transform 0.2s, background-color 0.2s;
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      button[name="toggle"] svg {
        position: relative;
      }
      button[name="toggle"]:hover {
        box-shadow: 0 2px 7px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: 0.2s ease;
      }

      button[name="toggle"]:active {
        transform: scale(0.95);
      }

      form[method="POST"] {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .config-form {
        background-color: #fff;
        padding: 1.5em;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-top: 1em;
        width: 100%;
        max-width: 350px;
      }

      .config-form input[type="number"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 3px solid #ccc;
        box-sizing: border-box;
        text-align: center;
      }

      .config-form input[type="submit"] {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background-color: #007aff;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .config-form input[type="submit"]:hover {
        background-color: #0056b3;
      }

      form .inp {
        position: relative;
        width: 100%;
      }
      form details {
        width: 100%;
        padding: 1em;
      }

      form details .inp {
        margin: 0 0.5em;
      }

      form .inp p {
        padding: 0 0.5em;
        margin: 0 1em;
        position: absolute;
        font-size: 1em;
        background: #fff;
      }

      form .inp input {
        margin-top: 1em;
      }

      /* Timer control buttons */
      .config-form .timer-controls {
        display: flex;
        gap: 0.5em;
        justify-content: center;
        align-items: center;
        width: 100%;
      }

      .config-form .timer-controls button {
        padding: 8px 12px;
        border-radius: 5em;
        border: none;
        background: #007aff;
        cursor: pointer;
        font-weight: bold;
        color: #fff;
      }

      .config-form .timer-controls button:active {
        transform: scale(0.98);
      }
    </style>
  </head>
  <body>
    <h2>Cocina</h2>

    <div class="status">
      <p>Estado: <b class="actual">%%STATUS%%</b></p>
      <p>Cocina: <b>%%OUTPUT_STATE%%</b></p>
    </div>

    <form method="POST" id="control-form">
      <div class="control-container" id="slider-container">
        <svg>
          <circle class="slider-track" cx="100" cy="100" r="90"></circle>
          <circle
            class="slider-progress"
            id="slider-progress"
            cx="100"
            cy="100"
            r="90"
          ></circle>
        </svg>
        <button name="toggle" value="1">
          <svg viewBox="0 -960 960 960" fill="a5f5a5">
            <path
              d="M480-80q-82.33 0-155.33-31.5-73-31.5-127.34-85.83Q143-251.67 111.5-324.67T80-480q0-84 31.83-156.5Q143.67-709 197.67-763l46.66 46.67q-46 45.33-71.83 106-25.83 60.66-25.83 130.33 0 138.67 97.33 236 97.33 97.33 236 97.33 139.33 0 236.33-97.33t97-236q0-69.67-25.5-130.33-25.5-60.67-71.5-106L763-763q54 54 85.5 126.5T880-480q0 82.33-31.5 155.33-31.5 73-85.5 127.34Q709-143 636-111.5T480-80Zm-33.33-360v-440h66.66v440h-66.66Z"
            />
          </svg>
        </button>
        <div id="pwm-value">0%</div>
      </div>
      <input
        type="hidden"
        name="pwm_duty"
        id="pwm_duty_input"
        value="%%PWM_DUTY%%"
      />
    </form>

    <div class="time">
      <p><b>%%TIME_LEFT%%</b></p>
    </div>

    <form method="POST" class="config-form">
      <div class="timer-controls">
        <button type="button" id="timer-decrease" title="-10 minutes">
          -10
        </button>
        <div class="inp">
          <p>Temporizador (min):</p>
          <input
            type="number"
            name="timer_minutes"
            id="timer_minutes_input"
            value="%%TIMER_MINS%%"
          />
          <br />
        </div>
        <button type="button" id="timer-increase" title="+10 minutes">
          +10
        </button>
      </div>
      <details>
        <summary>Configuraci√≥n</summary>
        <div class="inp">
          <p>Initial ON time (min):</p>
          <input type="number" name="initial_on_time" value="%%INITIAL_ON%%" />
        </div>
        <br />
        <div class="inp">
          <p>PWM Period (min):</p>
          <input type="number" name="pwm_period" value="%%PWM_PERIOD%%" /><br />
        </div>
      </details>
      <input type="submit" value="Establecer Tiempo" />
    </form>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const actualStatus = document
          .querySelector(".actual")
          .textContent.trim();
        const bd = document.body;
        const bt = document.querySelector("button[name='toggle'] > svg");
        if (actualStatus === "Off") {
          bd.style.backgroundColor = "#f0f0f0";
          bt.style.fill = "#a5f5a5";
        } else if (actualStatus === "On - Temporizador") {
          bd.style.backgroundColor = "#fff4e5";
          bt.style.fill = "#f5a5a5";
        } else if (actualStatus === "On - Regulado") {
          bd.style.backgroundColor = "#e5f7ff";
          bt.style.fill = "#f5a5a5";
        } else if (actualStatus === "On - Temporizador & Regulado") {
          bd.style.backgroundColor = "#e5ffe5";
          bt.style.fill = "#f5a5a5";
        } else {
          bd.style.backgroundColor = "#e5e5e5";
          bt.style.fill = "#a5f5a5";
        }
        const container = document.getElementById("slider-container");
        const progressCircle = document.getElementById("slider-progress");
        const pwmInput = document.getElementById("pwm_duty_input");
        const pwmValueDisplay = document.getElementById("pwm-value");
        const toggleButton = document.querySelector("button[name=toggle]");

        const radius = progressCircle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        progressCircle.style.strokeDasharray = circumference;

        let isDragging = false;

        updateSlider = (value) => {
          const val = Math.max(0, Math.min(100, value));
          const offset = circumference - (val / 100) * circumference;
          progressCircle.style.strokeDashoffset = offset;
          pwmInput.value = Math.round(val);
          pwmValueDisplay.textContent = `${Math.round(val)}%`;
        };

        getAngle = (event) => {
          const rect = container.getBoundingClientRect();
          const clientX = event.clientX || event.touches[0].clientX;
          const clientY = event.clientY || event.touches[0].clientY;
          const x = clientX - rect.left - rect.width / 2;
          const y = clientY - rect.top - rect.height / 2;
          let angle = Math.atan2(y, x) * (180 / Math.PI) + 90;
          if (angle < 0) {
            angle += 360;
          }
          return angle;
        };

        handleInteraction = (event) => {
          event.preventDefault();
          const angle = getAngle(event);
          const value = (angle / 360) * 100;
          updateSlider(value);
        };

        // Prevent slider interaction when clicking the button
        toggleButton.addEventListener("mousedown", (e) => e.stopPropagation());
        toggleButton.addEventListener("touchstart", (e) => e.stopPropagation());
        // Prevent reload
        // toggleButton.addEventListener('click', (e) => e.preventDefault());

        container.addEventListener("mousedown", (e) => {
          isDragging = true;
          handleInteraction(e);
        });

        container.addEventListener("touchstart", (e) => {
          isDragging = true;
          handleInteraction(e);
        });

        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            handleInteraction(e);
          }
        });

        document.addEventListener("touchmove", (e) => {
          if (isDragging) {
            handleInteraction(e);
          }
        });

        document.addEventListener("mouseup", (e) => {
          if (isDragging) {
            isDragging = false;
            // Automatically submit the form when the user releases the slider
            document.getElementById("control-form").submit();
          }
        });

        document.addEventListener("touchend", (e) => {
          if (isDragging) {
            isDragging = false;
            document.getElementById("control-form").submit();
          }
        });
        // Set initial value from the server-side variable
        const initialValue = parseInt(pwmInput.value, 10) || 0;
        updateSlider(initialValue);
        const updateState = async () => {
          try {
            const response = await fetch("/state");
            if (!response.ok) {
              console.error("Failed to fetch state");
              return;
            }
            const state = await response.json();

            // Update the page dynamically
            const statusElement = document.querySelector(".status .actual");
            const outputStateElement = document.querySelector(
              ".status b:nth-of-type(2)"
            );
            const timeLeftElement = document.querySelector(".time p b");
            const timerMinutesInput = document.querySelector(
              "input[name=timer_minutes]"
            );
            const initialOnTimeInput = document.querySelector(
              "input[name=initial_on_time]"
            );
            const pwmPeriodInput = document.querySelector(
              "input[name=pwm_period]"
            );
            const pwmDutyInput = document.querySelector("input[name=pwm_duty]");

            if (statusElement) statusElement.textContent = state.status;
            if (outputStateElement)
              outputStateElement.textContent = state.output_state;
            if (timeLeftElement) timeLeftElement.textContent = state.time_left;
            if (timerMinutesInput)
              timerMinutesInput.placeholder = state.timer_minutes;
            if (timerMinutesInput)
              timerMinutesInput.title = state.timer_minutes;
            if (initialOnTimeInput)
              initialOnTimeInput.placeholder = state.initial_on_time;
            if (initialOnTimeInput)
              initialOnTimeInput.title = state.initial_on_time;
            if (pwmPeriodInput) pwmPeriodInput.placeholder = state.pwm_period;
            if (pwmPeriodInput) pwmPeriodInput.title = state.pwm_period;
            if (pwmDutyInput) pwmDutyInput.value = state.pwm_duty;

            // Update slider dynamically
            const pwmValueDisplay = document.getElementById("pwm-value");
            const progressCircle = document.getElementById("slider-progress");
            const radius = progressCircle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const value = Math.max(0, Math.min(100, state.pwm_duty));
            const offset = circumference - (value / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            if (pwmDutyInput) pwmDutyInput.value = Math.round(value);
            if (pwmValueDisplay)
              pwmValueDisplay.textContent = `${Math.round(value)}%`;
          } catch (error) {
            console.error("Error fetching state:", error);
          }
        };

        // Fetch state every 1000 milliseconds
        setInterval(updateState, 1000);

        // Initial fetch
        updateState();
      });

      // Timer +/-10 buttons
      (function () {
        const incBtn = document.getElementById("timer-increase");
        const decBtn = document.getElementById("timer-decrease");
        const timerInput = document.getElementById("timer_minutes_input");

        const clamp = (v) => {
          if (isNaN(v) || v === null) return 0;
          return Math.max(0, Math.round(v));
        };

        if (incBtn && timerInput) {
          incBtn.addEventListener("click", (e) => {
            e.preventDefault();
            const cur = clamp(parseInt(timerInput.value, 10) || 0);
            timerInput.value = cur + 10;

            timerInput.placeholder = timerInput.value;
            timerInput.title = timerInput.value;
          });
        }

        if (decBtn && timerInput) {
          decBtn.addEventListener("click", (e) => {
            e.preventDefault();
            const cur = clamp(parseInt(timerInput.value, 10) || 0);
            timerInput.value = Math.max(0, cur - 10);
            timerInput.placeholder = timerInput.value;
            timerInput.title = timerInput.value;
          });
        }
      })();
    </script>
  </body>
</html>
